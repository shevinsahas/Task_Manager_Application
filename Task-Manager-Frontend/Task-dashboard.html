<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Task Manager Dashboard (View, Edit, Delete)">
  <meta name="author" content="TaskFlow">

  <title>Task Flow - Dashboard</title>


  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
  <link href="css/sb-admin-2.min.css" rel="stylesheet">

  <!-- SweetAlert -->
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

  <style>
    body {
      background-color: #f3f6fb;
      font-family: 'Nunito', sans-serif;
    }
    .table td, .table th { vertical-align: middle; }
    .badge { font-size: .75rem; }
    .spinner-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.25); z-index: 1055; }
  </style>
</head>

<body id="page-top">

  <div id="wrapper">
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">

        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <h5 class="mb-0 font-weight-bold text-gray-800">Task Dashboard</h5>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item mr-2">
              <button id="btnAdd" class="btn btn-sm btn-primary"><i class="fas fa-plus mr-1"></i>Add Task</button>
            </li>
            <li class="nav-item">
              <button id="btnRefresh" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync-alt mr-1"></i>Refresh</button>
            </li>
          </ul>
        </nav>

        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center flex-wrap gap-2">
                  <h6 class="m-0 font-weight-bold text-primary">Tasks</h6>
                  <div class="ml-auto d-flex align-items-center">
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                      </div>
                      <input id="searchInput" type="text" class="form-control" placeholder="Search title or description...">
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered" id="tasksTable" width="100%" cellspacing="0">
                      <thead class="thead-light">
                        <tr>
                          <th>Title</th>
                          <th class="d-none d-md-table-cell">Status</th>
                          <th class="d-none d-md-table-cell">Priority</th>
                          <th>Due</th>
                          <th class="d-none d-lg-table-cell">Updated</th>
                          <th style="width: 120px;">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="tasksTbody">
                        <tr>
                          <td colspan="6" class="text-center text-muted">Loading…</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>


      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>© Task Flow</span>
          </div>
        </div>
      </footer>

    </div>
  </div>


  <!-- Scripts -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

  <script>
    const API_BASE = 'http://localhost:8080/api/tasks';

    $(document).ready(function () {
      $('#btnRefresh').on('click', loadTasks);
      $('#searchInput').on('input', filterRows);
      $('#editForm').on('submit', onSaveEdit);
      $('#btnAdd').on('click', function(){ $('#createModal').modal('show'); });
      $('#createForm').on('submit', onSaveCreate);
      loadTasks();
    });

    function getAuthHeaders() {
      const token = localStorage.getItem('jwtToken');
      return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    function showSpinner(show) {
      $('#spinnerOverlay').css('display', show ? 'flex' : 'none');
    }

    function loadTasks() {
      showSpinner(true);
      $('#tasksTbody').html('<tr><td colspan="6" class="text-center text-muted">Loading…</td></tr>');
      $.ajax({
        url: API_BASE,
        method: 'GET',
        headers: getAuthHeaders(),
        success: function (data) {
          renderRows(data || []);
        },
        error: handleAjaxError,
        complete: function () { showSpinner(false); }
      });
    }

    function renderRows(tasks) {
      const $tbody = $('#tasksTbody');
      $tbody.empty();
      if (!tasks.length) {
        $tbody.append('<tr><td colspan="6" class="text-center text-muted">No tasks found</td></tr>');
        return;
      }

      tasks.forEach(t => {
        const statusBadge = badgeForStatus(t.status);
        const priorityBadge = badgeForPriority(t.priority);
        const due = t.dueDate ? formatDate(t.dueDate) : '—';
        const updated = t.updatedAt ? formatDateTime(t.updatedAt) : '—';

        const $tr = $('<tr></tr>');
        const $title = $('<td></td>');
        $('<div class="font-weight-bold"></div>').text(t.title || '').appendTo($title);
        if (t.description) $('<div class="small text-muted"></div>').text(t.description).appendTo($title);

        $tr.append($title);
        $tr.append(`<td class="d-none d-md-table-cell">${statusBadge}</td>`);
        $tr.append(`<td class="d-none d-md-table-cell">${priorityBadge}</td>`);
        $tr.append(`<td>${due}</td>`);
        $tr.append(`<td class="d-none d-lg-table-cell">${updated}</td>`);
        $tr.append(`
          <td class="text-right">
            <button class="btn btn-sm btn-outline-secondary mr-2" onclick='openEditModal(${JSON.stringify({id: t.id}).replace(/"/g, "&quot;")})'><i class="fas fa-pen"></i> Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick='confirmDelete(${JSON.stringify({id: t.id, title: t.title}).replace(/"/g, "&quot;")})'><i class="fas fa-trash"></i> Delete</button>
          </td>`);
        $tbody.append($tr);
      });

      filterRows();
    }

    

    function handleAjaxError(xhr) {
      if (xhr && xhr.status === 401) {
        swal({ text: 'Your session expired. Please login again.', icon: 'warning', button: 'Login' })
          .then(() => { window.location.href = 'login.html'; });
        return;
      }
      try {
        const message = (xhr.responseJSON && (xhr.responseJSON.message || xhr.responseJSON.error)) || xhr.responseText || 'Unknown error';
        swal({ text: message, icon: 'error', button: 'OK' });
      } catch (e) {
        swal({ text: 'An error occurred. Please try again.', icon: 'error', button: 'OK' });
      }
    }

    function badgeForStatus(s) {
      const map = {
        'TODO': 'secondary',
        'IN_PROGRESS': 'info',
        'DONE': 'success'
      };
      const cls = map[s] || 'light';
      return '<span class="badge badge-' + cls + '">' + (s || '') + '</span>';
    }

    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDate(iso) {
      try { const d = new Date(iso); return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); } catch { return iso; }
    }
    function formatDateTime(iso) {
      try { const d = new Date(iso); return d.toLocaleString(); } catch { return iso; }
    }
  </script>
</body>

</html>
