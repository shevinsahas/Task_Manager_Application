<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Task Manager Dashboard (View, Edit, Delete)">
  <meta name="author" content="TaskFlow">

  <title>Task Flow - Dashboard</title>

  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
  <link href="css/sb-admin-2.min.css" rel="stylesheet">

  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

  <style>
    body {
      background-color: #f3f6fb;
      font-family: 'Nunito', sans-serif;
    }
    .table td, .table th { vertical-align: middle; }
    .badge { font-size: .75rem; }
    .spinner-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.25); z-index: 1055; }
  </style>
</head>

<body id="page-top">

  <div id="wrapper">
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">

        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <h5 class="mb-0 font-weight-bold text-gray-800">Task Dashboard</h5>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item mr-2">
              <button id="btnAdd" class="btn btn-sm btn-primary"><i class="fas fa-plus mr-1"></i>Add Task</button>
            </li>
            <li class="nav-item">
              <button id="btnRefresh" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync-alt mr-1"></i>Refresh</button>
            </li>
          </ul>
        </nav>

        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center flex-wrap gap-2">
                  <h6 class="m-0 font-weight-bold text-primary">Tasks</h6>
                  <div class="ml-auto d-flex align-items-center">
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                      </div>
                      <input id="searchInput" type="text" class="form-control" placeholder="Search title or description...">
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered" id="tasksTable" width="100%" cellspacing="0">
                      <thead class="thead-light">
                        <tr>
                          <th>Title</th>
                          <th class="d-none d-md-table-cell">Status</th>
                          <th class="d-none d-md-table-cell">Priority</th>
                          <th>Due</th>
                          <th class="d-none d-lg-table-cell">Updated</th>
                          <th style="width: 120px;">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="tasksTbody">
                        <tr>
                          <td colspan="6" class="text-center text-muted">Loading…</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>© Task Flow</span>
          </div>
        </div>
      </footer>

    </div>

  </div>

  <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Task</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form id="editForm">
          <div class="modal-body">
            <input type="hidden" id="edit-id">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="edit-title">Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="edit-title" required>
              </div>
              <div class="form-group col-md-3">
                <label for="edit-status">Status</label>
                <select id="edit-status" class="form-control">
                  <option value="TODO">TODO</option>
                  <option value="IN_PROGRESS">IN_PROGRESS</option>
                  <option value="DONE">DONE</option>
                </select>
              </div>
              <div class="form-group col-md-3">
                <label for="edit-priority">Priority</label>
                <select id="edit-priority" class="form-control">
                  <option value="LOW">LOW</option>
                  <option value="MEDIUM" selected>MEDIUM</option>
                  <option value="HIGH">HIGH</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="edit-dueDate">Due date</label>
                <input type="date" class="form-control" id="edit-dueDate">
              </div>
              <div class="form-group col-md-4">
                <label>Created</label>
                <input type="text" class="form-control" id="edit-createdAt" disabled>
              </div>
              <div class="form-group col-md-4">
                <label>Updated</label>
                <input type="text" class="form-control" id="edit-updatedAt" disabled>
              </div>
            </div>
            <div class="form-group">
              <label for="edit-description">Description</label>
              <textarea id="edit-description" class="form-control" rows="4" placeholder="Optional details"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createModalLabel">Add New Task</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form id="createForm">
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="create-title">Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="create-title" required>
              </div>
              <div class="form-group col-md-3">
                <label for="create-status">Status</label>
                <select id="create-status" class="form-control">
                  <option value="TODO" selected>TODO</option>
                  <option value="IN_PROGRESS">IN_PROGRESS</option>
                  <option value="DONE">DONE</option>
                </select>
              </div>
              <div class="form-group col-md-3">
                <label for="create-priority">Priority</label>
                <select id="create-priority" class="form-control">
                  <option value="LOW">LOW</option>
                  <option value="MEDIUM" selected>MEDIUM</option>
                  <option value="HIGH">HIGH</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="create-dueDate">Due date</label>
                <input type="date" class="form-control" id="create-dueDate">
              </div>
            </div>
            <div class="form-group">
              <label for="create-description">Description</label>
              <textarea id="create-description" class="form-control" rows="4" placeholder="Optional details"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Task</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Spinner Overlay -->
  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <!-- Scripts -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

  <script>
    const API_BASE = 'http://localhost:8080/api/tasks'; 

    $(document).ready(function () {
      $('#btnRefresh').on('click', loadTasks);
      $('#editForm').on('submit', onSaveEdit);
      $('#btnAdd').on('click', function(){ $('#createModal').modal('show'); });
      $('#createForm').on('submit', onSaveCreate);
      loadTasks();
    });

    function getAuthHeaders() {
      const token = localStorage.getItem('jwtToken');
      return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    function showSpinner(show) {
      $('#spinnerOverlay').css('display', show ? 'flex' : 'none');
    }

    function loadTasks() {
      showSpinner(true);
      $('#tasksTbody').html('<tr><td colspan="6" class="text-center text-muted">Loading…</td></tr>');
      $.ajax({
        url: API_BASE,
        method: 'GET',
        headers: getAuthHeaders(),
        success: function (data) {
          renderRows(data || []);
        },
        error: handleAjaxError,
        complete: function () { showSpinner(false); }
      });
    }

    function renderRows(tasks) {
      const $tbody = $('#tasksTbody');
      $tbody.empty();
      if (!tasks.length) {
        $tbody.append('<tr><td colspan="6" class="text-center text-muted">No tasks found</td></tr>');
        return;
      }

      tasks.forEach(t => {
        const statusBadge = badgeForStatus(t.status);
        const priorityBadge = badgeForPriority(t.priority);
        const due = t.dueDate ? formatDate(t.dueDate) : '—';
        const updated = t.updatedAt ? formatDateTime(t.updatedAt) : '—';

        const $tr = $('<tr></tr>');
        const $title = $('<td></td>');
        $('<div class="font-weight-bold"></div>').text(t.title || '').appendTo($title);
        if (t.description) $('<div class="small text-muted"></div>').text(t.description).appendTo($title);

        $tr.append($title);
        $tr.append(`<td class="d-none d-md-table-cell">${statusBadge}</td>`);
        $tr.append(`<td class="d-none d-md-table-cell">${priorityBadge}</td>`);
        $tr.append(`<td>${due}</td>`);
        $tr.append(`<td class="d-none d-lg-table-cell">${updated}</td>`);
        $tr.append(`
          <td class="text-right">
            <button class="btn btn-sm btn-outline-secondary mr-2" onclick='openEditModal(${JSON.stringify({id: t.id}).replace(/"/g, "&quot;")})'><i class="fas fa-pen"></i> Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick='confirmDelete(${JSON.stringify({id: t.id, title: t.title}).replace(/"/g, "&quot;")})'><i class="fas fa-trash"></i> Delete</button>
          </td>`);
        $tbody.append($tr);
      });

    }


    function openEditModal(payload) {
      const id = payload.id;
      if (!id) return;
      showSpinner(true);
      $.ajax({
        url: API_BASE + '/' + id,
        method: 'GET',
        headers: getAuthHeaders(),
        success: function (t) {
          $('#edit-id').val(t.id);
          $('#edit-title').val(t.title || '');
          $('#edit-description').val(t.description || '');
          $('#edit-status').val(t.status || 'TODO');
          $('#edit-priority').val(t.priority || 'MEDIUM');
          $('#edit-dueDate').val(t.dueDate ? (t.dueDate.substr(0,10)) : '');
          $('#edit-createdAt').val(t.createdAt ? formatDateTime(t.createdAt) : '');
          $('#edit-updatedAt').val(t.updatedAt ? formatDateTime(t.updatedAt) : '');
          $('#editModal').modal('show');
        },
        error: handleAjaxError,
        complete: function () { showSpinner(false); }
      });
    }

    function onSaveEdit(e) {
        e.preventDefault();
        const id = $('#edit-id').val();
        const body = {
        title: ($('#edit-title').val() || '').trim(),
        description: $('#edit-description').val() || '',
        status: $('#edit-status').val() || 'TODO',
        priority: $('#edit-priority').val() || 'MEDIUM',
        dueDate: $('#edit-dueDate').val() || null
        };


        if (!body.title) {
        swal({ text: 'Title is required', icon: 'warning', button: 'OK' });
        return;
    }


    function resetCreateForm(){
        $('#create-title').val('');
        $('#create-description').val('');
        $('#create-status').val('TODO');
        $('#create-priority').val('MEDIUM');
        $('#create-dueDate').val('');
    }


    showSpinner(true);
    $.ajax({
        url: API_BASE + '/' + id,
        method: 'PUT',
        headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
        data: JSON.stringify(body),
        success: function () {
    $('#editModal').modal('hide');
        swal({ text: 'Task updated', icon: 'success', button: 'OK' });
        loadTasks();
    },
        error: handleAjaxError,
        complete: function () { showSpinner(false); }
    });
    }


    // === Create Task (global) ===
    function onSaveCreate(e) {
        e.preventDefault();
        const body = {
        title: ($('#create-title').val() || '').trim(),
        description: $('#create-description').val() || '',
        status: $('#create-status').val() || 'TODO',
        priority: $('#create-priority').val() || 'MEDIUM',
        dueDate: $('#create-dueDate').val() || null
    };
    if (!body.title) {
        swal({ text: 'Title is required', icon: 'warning', button: 'OK' });
        return;
    }
        showSpinner(true);
        $.ajax({
            url: API_BASE,
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
            data: JSON.stringify(body),
            success: function () {
    $('#createModal').modal('hide');
        swal({ text: 'Task created', icon: 'success', button: 'OK' });
        loadTasks();
    },
        error: handleAjaxError,
        complete: function () { showSpinner(false); }
    });
    }


    function resetCreateForm(){
        $('#create-title').val('');
        $('#create-description').val('');
        $('#create-status').val('TODO');
        $('#create-priority').val('MEDIUM');
        $('#create-dueDate').val('');
    }
    
    function confirmDelete(payload) {
      const id = payload.id; const title = payload.title || 'this task';
      swal({
        title: 'Delete task?',
        text: 'Are you sure you want to delete "' + title + '"? This action cannot be undone.',
        icon: 'warning',
        buttons: [true, 'Delete'],
        dangerMode: true,
      }).then((willDelete) => {
        if (willDelete) doDelete(id);
      });
    }

    function doDelete(id) {
      if (!id) return;
      showSpinner(true);
      $.ajax({
        url: API_BASE + '/' + id,
        method: 'DELETE',
        headers: getAuthHeaders(),
        success: function () {
          swal({ text: 'Task deleted', icon: 'success', button: 'OK' });
          loadTasks();
        },
        error: handleAjaxError,
        complete: function () { showSpinner(false); }
      });
    }

    function handleAjaxError(xhr) {
      if (xhr && xhr.status === 401) {
        swal({ text: 'Your session expired. Please login again.', icon: 'warning', button: 'Login' })
          .then(() => { window.location.href = 'login.html'; });
        return;
      }
      try {
        const message = (xhr.responseJSON && (xhr.responseJSON.message || xhr.responseJSON.error)) || xhr.responseText || 'Unknown error';
        swal({ text: message, icon: 'error', button: 'OK' });
      } catch (e) {
        swal({ text: 'An error occurred. Please try again.', icon: 'error', button: 'OK' });
      }
    }

    // UI helpers
    function badgeForStatus(s) {
      const map = {
        'TODO': 'secondary',
        'IN_PROGRESS': 'info',
        'DONE': 'success'
      };
      const cls = map[s] || 'light';
      return '<span class="badge badge-' + cls + '">' + (s || '') + '</span>';
    }
    function badgeForPriority(p) {
      const map = {
        'LOW': 'success',
        'MEDIUM': 'warning',
        'HIGH': 'danger'
      };
      const cls = map[p] || 'light';
      return '<span class="badge badge-' + cls + '">' + (p || '') + '</span>';
    }
    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDate(iso) {
      try { const d = new Date(iso); return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); } catch { return iso; }
    }
    function formatDateTime(iso) {
      try { const d = new Date(iso); return d.toLocaleString(); } catch { return iso; }
    }
  </script>
</body>

</html>
